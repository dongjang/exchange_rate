<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.example.remittance.mapper.RemittanceMapper">

    <select id="getDailyLimit" resultType="BigDecimal">
        <!-- 일일 한도 체크 -->
        SELECT IFNULL(url.daily_limit, def.daily_limit) - IFNULL(SUM(r.amount), 0) AS daily_limit
        FROM default_remittance_limit def
        LEFT JOIN user_remittance_limit url ON url.user_id = #{userId}
        LEFT JOIN remittance r ON r.user_id = #{userId}
        AND r.status = 'COMPLETED'
        AND r.created_at BETWEEN 
        CASE 
            WHEN DATE(url.updated_at) = CURDATE() THEN url.updated_at
            ELSE CURDATE()
        END
        AND CONCAT(CURDATE(), ' 23:59:59')
        WHERE def.is_active = true
    </select>

    <select id="getMonthlyLimit" resultType="BigDecimal">
        <!-- 월 한도 체크 -->
        SELECT IFNULL(url.monthly_limit, def.monthly_limit) - IFNULL(SUM(r.amount), 0) AS monthly_limit
        FROM default_remittance_limit def
        LEFT JOIN user_remittance_limit url ON url.user_id = #{userId}
        LEFT JOIN remittance r ON r.user_id = #{userId}
        AND r.status = 'COMPLETED'
        AND r.created_at BETWEEN 
        CASE 
            WHEN DATE_FORMAT(url.updated_at, '%Y-%m') = DATE_FORMAT(CURDATE(), '%Y-%m')
            THEN url.updated_at
            ELSE DATE_FORMAT(CURDATE(), '%Y-%m-01')
        END
        AND CONCAT(LAST_DAY(CURDATE()), ' 23:59:59')
        WHERE def.is_active = true
    </select>

    <select id="getUserLimits" resultType="UserLimitsResponse">
        <!-- 사용자별 한도 조회 -->
        SELECT 
            IFNULL(url.daily_limit, def.daily_limit) AS dailyLimit,
            IFNULL(url.monthly_limit, def.monthly_limit) AS monthlyLimit,
            IFNULL(url.single_limit, def.single_limit) AS singleLimit,
            CASE
                WHEN url.daily_limit IS NULL THEN 'DEFAULT_LIMIT'
                ELSE 'USER_LIMIT'
            END AS limitType
        FROM default_remittance_limit def
        LEFT JOIN user_remittance_limit url ON url.user_id = #{userId}
        WHERE def.is_active = true
    </select>

</mapper> 